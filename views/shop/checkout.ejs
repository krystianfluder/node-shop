<%- include('../includes/head.ejs') %>
</head>

<body>
  <%- include('../includes/navigation.ejs') %>
  <main class="container">
    <%- include('../includes/breadcrumbs-and-header.ejs') %>

    <div id="content">Loading...</div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        var stripe = Stripe('<%= process.env.STRIPE_PUBLISHABLE_KEY %>');

        const contentDiv = document.getElementById('content');
        let loading = true;

        fetch(`<%= process.env.BASE_URL %>/cart-items`).then(res => res.json()).then(res => {
          const { totalPrice, products } = res;
          const fragment = document.createDocumentFragment();
          const fragmentHeader = document.createElement('h2');
          const fragmentBody = document.createElement('div');

          // order button
          const fragmentButton = document.createElement('button');
          fragmentButton.textContent = "Order"
          fragmentButton.id = 'order-btn'

          // total price h2
          fragmentHeader.textContent = `Total price: ${totalPrice/100}`
          fragment.appendChild(fragmentHeader)

          // create cards
          products.forEach(product => {
            const productDiv = document.createElement('div');
            productDiv.classList.add('card');
            const cardHeader = document.createElement('div');
            cardHeader.classList.add('card-header');
            const cardBody = document.createElement('div');
            cardBody.classList.add('card-body');

            cardHeader.textContent = `Product: ${product.productId.title}`;
            cardBody.textContent = JSON.stringify(product)  
            
            productDiv.appendChild(cardHeader);
            productDiv.appendChild(cardBody)
            fragmentBody.appendChild(productDiv);
          })

          const parseProducts = products.map(product => {
            return {
              "_id": product.productId._id,
              quantity: product.quantity
            }
          });

          fragmentButton.addEventListener('click', () => {
            fetch(`<%= process.env.BASE_URL %>/checkout`, { method: 'POST',
              headers: {
              'Content-Type': 'application/json',
              'X-CSRF-TOKEN': '<%= csrfToken %>'
              },
              body: JSON.stringify({
                products: parseProducts
              })
            })
            .then(res => res.json())
            .then(res => {
              if (res.message === "Order created") {
                return stripe.redirectToCheckout({sessionId: res.session.id})
              }
            })
          })

          fragment.appendChild(fragmentBody)
          fragment.appendChild(fragmentButton)        

          contentDiv.appendChild(fragment)
          loading = false;
        })   
    </script>
  </main>

  <%- include('../includes/end.ejs') %>